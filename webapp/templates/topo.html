{% extends 'layout.html' %}
{% block body %}

    <h1 class ='retroshadow'><img width="40" height="40" src="{{url_for('static', filename='icon.png')}}"/>Viewing Glass</h1> 
    
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdn.ckeditor.com/4.6.2/basic/ckeditor.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>

    <div id="mynetwork"></div>

    <div id="titlebar"<></div>

    <div id="infobox"></div>

    <script type="text/javascript">

        var responseJSON;

        var nodes = new vis.DataSet([
            {% for device in topologyInfo['devices'] %}
            {% if loop.index != topologyInfo['devices']|length %}
            {% if "host" not in device['id'] %}
            {id: '{{device['id']}}', label: '{{device['id']}}', title: 'Node: <b> {{device['id']}} </b><br>Type: Switch', image: "{{url_for('static', filename='switch.png')}}", shape: 'image'},
            {% elif "host" in device['id'] %}
            {id: '{{device['id']}}', label: '{{device['ip']}}', title: 'Node: <b> {{device['id']}} </b><br>Type: Host', image: '{{url_for('static', filename='host.png')}}', shape: 'image'},
            {% endif %}
            {% elif  loop.index == topologyInfo['devices']|length %}
            {% if "host" not in device['id'] %}
            {id: '{{device['id']}}', label: '{{device['id']}}', title: 'Node: <b> {{device['id']}} </b><br>Type: Switch', image: "{{url_for('static', filename='switch.png')}}", shape: 'image'}
            {% elif "host" in device['id'] %}
            {id: '{{device['id']}}', label: '{{device['ip']}}', title: 'Node: <b> {{device['id']}} </b><br>Type: Host', image: '{{url_for('static', filename='host.png')}}', shape: 'image'}
            {% endif %}
            {% endif %}
            {% endfor %}
        ]);

        var edges = new vis.DataSet([
            {% for link in topologyInfo['connections'] %}
            {% if loop.index != topologyInfo['connections']|length %}
            {id: '{{link['src_port']}}-{{link['dst_port']}}', from: '{{link['src']}}', to: '{{link['dst']}}', title: 'Source Port: <b> {{link['src_port']}} </b><br>Dst Port: <b>{{link['dst_port']}}</b>'},
            {% elif  loop.index == topologyInfo['connections']|length %}
            {id: '{{link['src_port']}}-{{link['dst_port']}}', from: '{{link['src']}}', to: '{{link['dst']}}', title: 'Source Port: <b> {{link['src_port']}} </b><br>Dst Port: <b>{{link['dst_port']}}</b>'}
            {% endif %}
            {% endfor %}
        ]);
    
        // create a network
        var container = document.getElementById('mynetwork');
    
        // provide the data in the vis format
        var data = {
            nodes: nodes,
            edges: edges
        };
        
        var options = {
			interaction:{hover:true}
		};

        var network = new vis.Network(container, data, options);
        
        //Event Handler to catch when user hovers a node
        network.on("hoverNode", function (params) {
            var node = String(params.node);
            //Limitation: Switch names must include openflow atm.
            if (node.includes('openflow')){
                throughputInfo(node);
            }
        });
        
        //Event Handler to catch when user right clicks on a node
        network.on("selectNode", function (params) {
            document.getElementById('titlebar').innerHTML = '';
            document.getElementById('infobox').innerHTML = '';
            var node = String(params.nodes);

            //Limitation: Switch names must include openflow atm. 
            if (node.includes('openflow')) {
                document.getElementById('titlebar').innerHTML = '<h2>'+'<a href="switch/'+ node +'">' + node +'</a></h2>';
                switchStats(node);
            } else {
                hostStats(node);
            }
        });

        //Event Handler to catch when user right clicks on an edge
        network.on("selectEdge", function (params) {
            
            var node = String(params.nodes);

            if (node.length == 0){
                var edgeName = String(params.edges);
                //Feature disabled for now
                //edgeInfo(edgeName);
            }      
        });
    </script>

{% endblock %}
 